# OSN 规范

中文 | [English](README.md)

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

> OSN（Object Serialization Notation）是一种用于对象序列化的文本格式，旨在提供一种易于阅读、解析和生成的数据表示方式。  
> 它的设计灵感来源于JSON，但在可读性和灵活性方面进行了改进。

OSN使用键值对结构（ `键:值` ）表示成员，冒号（`:`）的左侧是键，右侧是值。

- 键可是任意单行文本，如果键的文本仅包含字母、数字、下划线和横线，则可以省略包裹键的双引号（`"`），否则必须使用双引号包裹键，按字符串规则（参考【字符串-单行字符串】部分）处理。
- 值可以是数值、布尔值、字符串、数组、对象或 `null` 。

每行可以书写任意个键值对结构。如果一行内有多个键值对结构，必须使用逗号（`,`）分隔它们；如果一行内只有一个键值对结构，可以省略该行的分隔符逗号。最后一个键值对结构后允许有尾随分隔符逗号。各键值对结构中间的多余空白字符会被忽略。


完整示例：[sample.osn](./sample.osn)


## 注释

OSN支持单行注释。注释以 `//` 开头，直到行尾，注释中的内容会被解析器忽略。注释可以出现在除多行字符串外的任何位置。

示例：
```js
// 这是一行注释，可以独占一行
Key: "Value" // 注释也可以跟在键值对结构后面
```


## 数据类型

### 数值

OSN支持整数和浮点数，允许使用科学记数法、二进制、八进制和十六进制表示法。数字之间可以使用下划线（`_`）作为分隔符以提高可读性。

使用科学记数法、二进制、八进制和十六进制表示法时，字母部分不区分大小写。

示例：
```js
IntegerValue: 42
FloatValue: 3.14
NumberFieldScientific: 3.14E-10
BinaryValue: 0b0010_1010
OctalValue: 0o52
HexValue: 0x2A
```


### 布尔值

OSN使用**小写的** `true` 和 `false` 作为布尔字面量。

示例：
```js
BooleanValue1: true
BooleanValue2: false
```


### 字符串

OSN支持单行字符串和多行字符串。字符串中不支持嵌入环境变量（参考【环境变量】部分）。

**单行字符串** 使用双引号（`"`）包裹，支持转义字符，规则与JSON一致（遵循【RFC 8259】）。

**多行字符串** 使用三引号（`"""`）包裹，其中的所有字符都被视为字面量，不支持转义。多行字符串内容文本不能与三引号在同一行，并且每行文本必须以管道符（`|`）开始。每一行中，管道符前的所有空白字符会被忽略，管道符后的所有内容会被保留，包括其他管道符和前导/尾随空白字符。只包含一个管道符的行（可带有前导/尾随空白字符）代表一个空行。

示例：
```js
SingleLineStringField: "Hello World!",
SingleLineStringFieldWithEscape: "说：\n\"你好！\"",
MultiLineStringField: """
                      |这是一个多行字符串，可以书写多行内容。
                      |该 `"""` 区间内的所有字符都被视为字面量，不支持转义和注释。
                      |每行内容必须以管道符 `|` 开始，以便控制缩进。
                      |// 这是该多行字符串的一部分，而非OSN注释。
                      |下一行是空行：
                      |
                      """,
```


### 数组

OSN使用方括号（`[]`）表示数组，数组元素位于方括号内，可以是任意类型的值。如果一行内有多个数组元素，必须使用逗号（`,`）分隔它们；如果一行内只有一个数组元素，可以省略该行的分隔符逗号。各数组元素中间的多余空白字符会被忽略。

示例：
```js
ArrayOfIntegers: [1, 2, 3]
ArrayOfStrings: [
    "你好"
    "Hello"
]
ArrayOfArrays: [
    [1, 2]
    [3, 4]
]
```


### 对象

OSN使用花括号（`{}`）表示对象，对象成员位于花括号内，以键值对结构表示。在编程语言中，OSN对象可以被解析为该编程语言的对象或字典。

对象中的同级键必须是唯一的，但子级键（嵌套对象的键）可以与父级键相同。

一个OSN文档本身即表示一个对象，文档级对象的花括号可以省略。

示例1：
```js
ObjectField: {
    Field1: "Value",
    Field2: 42,
    Field3: [1, 2, 3],
    Field4: {
        SubField1: "SubValue1",
        SubField2: true
    }
    "Special Key": "含有特殊字符的键需要用双引号包裹"
}
```

**成员访问符**：可以使用成员访问符点（`.`）来访问对象成员。成员访问符前后的空白字符会被忽略，在双引号中的点符号不会被视为成员访问符。

示例2（内容与此节示例1内容等价）：
```js
ObjectField.Field1: "Value"
ObjectField.Field4.SubField1: "SubValue1"
ObjectField: {
    Field2: 42,
    Field3: [1, 2, 3],
    Field4: {
        SubField2: true
    }
}
```


### null

OSN使用**小写的** `null` 表示空对象或无值。使用 `null` 表示非可空类型时，解析器应该允许通过参数控制将其解析为默认值或报告错误。

示例：
```js
ObjectField: null
IntegerField: null // 可能被解析为0，也可能报错，取决于解析器的参数
```


## 指令（待定）

OSN支持通过指令指定解析器的行为或提供元数据。指令是可选的，但不能对同一成员重复添加相同指令。指令并非强制约束，解析器应该允许通过参数控制在OSN内容不满足指令约束时，要忽略、报告警告或者报告错误。

指令以 `@` 符号开头，后跟指令名称和指令参数。
- 指令名称全部使用**小写**字母。
- 指令参数需要放在括号（`()`）内，区分大小写，**不要**使用双引号包裹指令参数。
- 没有参数的指令可以省略指令名称后的括号。

指令分为文档指令、标记指令、引用指令和环境变量。

### 文档指令

文档指令位于OSN文档的所有键值对之前，作用于整个文档。

#### @omd()

`@omd()` 指令用于指定该OSN文档的OMD（Object Model Definition）文件，参数是OMD文件路径，参数中可以插入环境变量（参考【环境变量】部分），支持相对路径、绝对路径和远程路径。解析器应该支持通过参数控制是否允许远程路径、支持处理远程路径的安全性问题。

OMD文件中定义了对象的类型、字段名、字段类型、字段约束等信息。OMD文件中的定义可能与OSN文档内嵌的指令冲突，当发生冲突时，OSN文档内嵌的指令优先级更高，解析器应该允许通过参数控制是否对冲突报告警告或错误报告。

如果OSN文档中没有指定 `@omd()` 指令，且OSN文件所在的文件夹内含有名为 `.omd` 的OMD文件，则该OMD文件会被作为默认的OMD文件使用。

示例：
```js
// ${OMD_ROOT} 是一个环境变量，解析时会被替换为实际的路径
@omd(${OMD_ROOT}/sample.omd)
// 各个键值对结构……
```

### 标记指令

标记指令用于标记OSN文档中的特定键值对结构，位于被标记的键值对结构的上一行或行首。标记指令与被标记的键值对结构之间可以有任意数量的空白字符。

#### @type()

`@type()` 指令用于指定被标记的键值对结构的值的运行时类型，参数是类型的完全限定名。

示例：
```js
@type(MyNamespace.MyType)
ObjectField: {
    // ObjectField在运行时会被解析为MyNamespace.MyType类型的对象
    // ……
}
```

#### @notnull

`@notnull` 指令用于标记一个键值对结构的值不能为空，没有参数，可以省略括号。

OSN中默认允许值为空。带有 `@notnull` 标记时，如果该键值对结构的值为 `null`，解析器应该允许通过参数控制是否报告错误。

示例：
```js
// 解析器可能对以下内容报告错误，取决于参数设置
@notnull() StringField: null
@notnull // 括号是可选的
ObjectField: null
```

### 引用指令

引用指令用于引用当前或其他OSN文档中的成员值，位于键值对结构的值的位置（作为值）。

#### @ref()

`@ref()` 指令用于引用当前或其他OSN文档中的成员值，参数是目标成员值的键的路径，参数格式是 `OSN文档路径::键路径` ，其中：
- `OSN文档路径` 部分表示目标OSN文档的路径，可以插入环境变量（参考【环境变量】部分），支持相对路径、绝对路径和远程路径。
  - OSN文档路径部分为空时表示引用当前OSN文档。
  - 解析器应该支持通过参数控制是否允许远程路径、支持处理远程路径的安全性问题。
- `键路径` 部分表示目标成员值的键在对应的OSN文档中的路径，使用成员访问符（`.`）（参考【对象-成员访问符】）分隔各级键。
  - 如果键名中包含特殊字符，则需要使用双引号包裹该键名（参考【键】规则部分）。
  - 如果允许引用链路中间存在空值，可以使用成员安全访问符（`?.`）替代成员访问符（`.`），表示如果该成员值为 `null` ，则整个引用结果为 `null` 。
  - 未使用成员安全访问符时，解析器应该对引用链路中间的空值报告错误。
- `::` 是 `OSN文档路径` 和 `键路径` 的分隔符。

解析器应该支持处理循环引用。

示例：
```js
// 引用 other.osn 文档中的 ObjectField.Field1 成员值，如果 ObjectField 为 null ，解析器会报告错误
Key1: @ref(${COMMON_OSN_ROOT}/other.osn::ObjectField.Field1)
// 使用成员安全访问符，如果 ObjectField 为 null，则 Key2 的值为 null ，解析器不会报告错误
Key2: @ref(${COMMON_OSN_ROOT}/other.osn::ObjectField?.Field1)
```


### 环境变量

OSN支持在键值对结构的值中使用 `${}` 引用环境变量，花括号中需要写入环境变量的名字。环境变量的名字只能由数字、字母、下划线组成，不要使用双引号包裹环境变量名。

解析器会在解析时将环境变量引用替换为实际的运行时环境变量值。解析器应该允许通过参数控制将未定义的环境变量解析为默认值或报告错误。解析器要处理环境变量的安全性问题。

示例：
```js
EnvironmentVariable: ${GAME_VERSION}
```
